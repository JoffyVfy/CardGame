---
config:
  layout: fixed
---
flowchart TB
 subgraph APPLICATION["APPLICATION"]
        AppDelegate["AppDelegate<br>• applicationDidFinishLaunching() - 程序入口，创建场景和控制器"]
  end
 subgraph MANAGER["MANAGER LAYER (管理器层)"]
        GameManager["GameManager<br>━━━━━━━━━━━━━━<br>职责: 纯数据操作<br>━━━━━━━━━━━━━━<br>• setGameModel()<br>• getGameModel()<br>• moveReserveToStack()<br>• movePlayfieldToStack()<br>• moveStackToReserve()<br>━━━━━━━━━━━━━━<br>成员: _model"]
  end
 subgraph SERVICE["SERVICE LAYER (服务层)"]
        GameGeneratorService["GameGeneratorService<br>━━━━━━━━━━━━━━━━<br>职责: 生成游戏模型<br>━━━━━━━━━━━━━━━━<br>• generateGameModel()<br>(静态方法)<br>根据 LevelConfig<br>创建 GameModel"]
  end
 subgraph CONFIG["CONFIG LAYER (配置层)"]
        LevelConfigLoader["LevelConfigLoader<br>━━━━━━━━━━━━━━━━<br>• loadFromJson()<br>• loadLevelConfig()<br>• parseCardData()<br>解析 JSON 关卡文件"]
        LevelConfig["LevelConfig<br>━━━━━━━━━━━━━━━━<br>• addPlayfieldCard()<br>• addReserveCard()<br>• addStackCard()<br>• getPlayfieldCards()<br>• getReserveCards()<br>• getStackCards()"]
        CardData["CardData (结构体)<br>━━━━━━━━━━━━━━━━<br>• face, suit<br>• physicalPosition"]
  end
 subgraph MODEL["MODEL LAYER (数据模型层)"]
        GameModel["GameModel<br>━━━━━━━━━━━━━━━━━━<br>职责: 游戏状态数据容器<br>━━━━━━━━━━━━━━━━━━<br>• reserveCards - 备用牌区卡牌列表<br>• stackCards - 手牌堆卡牌列表<br>• playfieldCards - 主牌区卡牌列表<br>• getCardById() - 根据ID查找卡牌"]
        CardModel["CardModel<br>━━━━━━━━━━━━━━━━━━<br>职责: 单张卡牌数据<br>━━━━━━━━━━━━━━━━━━<br>• getId() - 获取唯一ID<br>• getSuit() - 获取花色 (枚举)<br>• getFace() - 获取点数 (1-13)<br>• setPosition() - 设置位置<br>• getX/Y() - 获取坐标<br>• flip() - 翻转卡牌<br>• isRed/Black() - 判断颜色<br>━━━━━━━━━━━━━━━━━━<br>CardSuit 枚举: HEARTS, DIAMONDS,<br>CLUBS, SPADES"]
  end
 subgraph VIEW["VIEW LAYER (视图层)"]
        GameScene["GameScene (继承 cocos2d::Scene)<br>━━━━━━━━━━━━━━━━━━━━━━━━━━<br>职责: 游戏主场景，管理三个区域和用户交互<br>━━━━━━━━━━━━━━━━━━━━━━━━━━<br>• createScene() - 创建场景<br>• init() - 初始化布局和触摸监听<br>• initGameView(model) - 根据模型创建所有卡牌精灵<br>• getCardSpriteById() - 根据ID查找卡牌精灵<br>• getStackCardPosition() - 获取手牌堆位置<br>• updateReserveLayout() - 重排备用牌区（带动画）<br>• showVictoryUI() - 显示胜利界面<br>• setOnXxxClick() - 设置回调函数<br>━━━━━━━━━━━━━━━━━━━━━━━━━━<br>私有方法:<br>• setupLayout() - 初始化三个区域容器<br>• setupTouchListener() - 设置触摸事件监听<br>━━━━━━━━━━━━━━━━━━━━━━━━━━<br>成员:<br>• _playFieldArea (主牌区容器)<br>• _reserveArea (备用牌区容器, Tag=100)<br>• _stackArea (手牌堆容器, Tag=101)<br>• _onReserveCardClick, _onPlayfieldCardClick, _onUndoClick (回调)"]
        CardView["CardView (继承 cocos2d::Node)<br>━━━━━━━━━━━━━━━━━━━━━━<br>职责: 单张卡牌的视觉表现<br>━━━━━━━━━━━━━━━━━━━━━━<br>• create(card) - 工厂方法，创建卡牌精灵<br>• init(card) - 初始化精灵组件<br>• getCard() - 获取关联的 CardModel<br>━━━━━━━━━━━━━━━━━━━━━━<br>私有方法:<br>• getBigNumberImageName() - 获取中央大数字图片路径<br>• getSmallNumberImageName() - 获取左上角小数字图片路径<br>• getSuitImageName() - 获取花色图片路径<br>• isRedSuit() - 判断是否红色花色<br>━━━━━━━━━━━━━━━━━━━━━━<br>成员: card, backgroundSprite, numberSprite, suitSprite"]
  end
 subgraph s1["CONTROLLER LAYER (控制器层)"]
        GameController["GameController (单例)<br>━━━━━━━━━━━━━━━━━━━━━━<br>核心职责: 协调 Model 与 View，处理游戏逻辑流程<br>━━━━━━━━━━━━━━━━━━━━━━<br>• getInstance() - 获取单例实例<br>• startGame(scene, levelId) - 启动关卡，加载配置，初始化视图<br>• handleReserveCardClick() - 处理备用牌区点击事件<br>• handlePlayfieldCardClick() - 处理主牌区点击事件（含遮挡检测）<br>• moveReserveToStack() - 备用牌 → 手牌堆（带动画）<br>• movePlayfieldToStack() - 主牌区 → 手牌堆（带动画）<br>• undoLastMove() - 撤销操作: 手牌堆 → 备用牌区<br>• checkVictory() - 检查胜利条件<br>━━━━━━━━━━━━━━━━━━━━━━<br>成员: gameManager, gameScene, config, isAnimating (动画锁)"]
  end
    LevelConfigLoader --> LevelConfig
    LevelConfig --> CardData
    GameModel --> CardModel
    GameScene --> CardView
    APPLICATION --> s1
    s1 --> MANAGER & SERVICE & CONFIG
    MANAGER --> MODEL
    MODEL --> VIEW

     AppDelegate:::appStyle
     GameManager:::managerStyle
     GameGeneratorService:::serviceStyle
     LevelConfigLoader:::configStyle
     LevelConfig:::configStyle
     CardData:::configStyle
     GameModel:::modelStyle
     CardModel:::modelStyle
     GameScene:::viewStyle
     CardView:::viewStyle
     GameController:::controllerStyle
    classDef appStyle fill:#e1f5ff,stroke:#01579b,stroke-width:2px,color:#000
    classDef controllerStyle fill:#fff9c4,stroke:#f57f17,stroke-width:2px,color:#000
    classDef managerStyle fill:#f3e5f5,stroke:#4a148c,stroke-width:2px,color:#000
    classDef serviceStyle fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px,color:#000
    classDef configStyle fill:#fce4ec,stroke:#880e4f,stroke-width:2px,color:#000
    classDef modelStyle fill:#e0f2f1,stroke:#004d40,stroke-width:2px,color:#000
    classDef viewStyle fill:#fff3e0,stroke:#e65100,stroke-width:2px,color:#000